# Exploratory analysis

Here you can check data fields and fields descriptions for all variables appearing in the dataset

**Variables related with the trade process:**

* **control_number**: It represents a unique individual shipment processed by the USFWS.
* **quantity**: It represents the numeric quantity of the wildlife produc 
* **unit**: It represents the unit for the numeric quantity
* **import_export**: It represents whether the shipment is an (I)mport or (E)xport
* **action**: Action taken by USFWS on import ((C)leared/(R)efused)
* **shipment_date**: Full date when shipment arrived
* **shipment_year**: Year when the shipment arrived (derived from "shiptment_year")
* **disposition**: Fate of the import
* **disposition_date**: Full date when disposition occurred
* **disposition_year**: Year when disposition occurred (derived from "disposition_date")

**Variables related with the countries:**

* **country_origin**: It represents the code for the country of origin of the wildlife product
* **country_imp_exp**: It represents the code for the country to/from which the wildlife product is shipped
* **port**: It represents the port or region of shipment entry
* **us_co**: It represents the US party of the shipment
* **foreign_co**: It represents the foreign party of the shipment

**Variables related with the product:**

* **description**: It represents the type/form of the wildlife product
* **value**: It represents the reported value of the wildlife product in US dollars
* **purpose**: It represents the reason the wildlife product is being imported
* **source**: It represents the type of source within the origin country (e.g., wild, bred)
* **species_code**: It represents the USFWS code for the wildlife product
* **taxa**: It represents the USFWS-derived broad taxonomic categorization
* **class**: It represents the EHA-derived class-level taxonomic designation
* **genus**: It represents the Genus (or higher-level taxonomic name) of the wildlife product
* **species**: It represents species of the wildlife product
* **subspecies**: It represents subspecies of the wildlife product
* **specific_name**: It represents a specific common name for the wildlife product
* **generic_name**: It represents a general common name for the wildlife product

## Variables related with the trade process:

### control_number 
**It represents a unique individual shipment processed by the USFWS.** A **shipment** refers to any container or group of containers that share a common control number, country of shipment and shipment date. Each shipment may be represented in the lemis dataset by multiple segments or rows, because the contents are derived from more than one species or type of product.  

- There are 2,079,637 unique shipments containing 5,451,832 segments.
- Of those, 60% (1,265,491 unique shipments) represent single segments. It means that for 1,265,491 shipments only one species and one type of product were discovered. The remaining 40% (814,146 unique shipments) contain 4,186,341 segments.
- These multiple segments shipments contain from 2 to 492 segments. The average number of segments in this kind of shipments is 5; the median is 3. 


```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$control_number <- droplevels(data$control_number)

# Unique shipments
shipments<- data %>% dplyr::group_by(control_number) %>%
  dplyr::summarise(size_segments=n()) %>% ungroup() %>%
  mutate(type_segment = ifelse(size_segments==1, "single", "multiple")) %>%
  mutate(type_segment=as.factor(type_segment))

shipments<- shipments %>% select(size_segments, type_segment) %>%
  mutate(size_segments=as.factor(size_segments)) %>% 
  dplyr::group_by(size_segments) %>%
  dplyr::summarise(total_shipments=n())

DT::datatable(shipments, rownames = FALSE,
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 1: ', 
                htmltools::em('Number of unique shipments based on the amount of
                              segments'))) %>%
  formatRound('total_shipments',1) 

rm(shipments)
```

### quantity and unit
**Quantity** represents the numeric quantity of the wildlife product, while **unit** represents the unit of measure for the numeric quantity.

- There are 13 types of units. 94.64% of data is measured with the unit "Number" (the number of individual wildlife items).
- The shipments include around 11,5 billions of wildlife items plus 1,1 billion kg of wildlife items only measured in weight.  

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
units <-data %>% group_by(unit) %>%
  summarise(total_segments = n(),percentage=n()/nrow(data)) %>%
  drop_na(unit) %>%
  arrange(desc(percentage)) 

DT::datatable(units, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 1: ', 
                htmltools::em('Units of measure'
              ))) %>%
  formatRound('total_segments',1) %>%
  formatPercentage('percentage',2)

data$quantity<- as.numeric(data$quantity)

quantity<- data %>%
  dplyr::group_by(unit) %>%
  drop_na(quantity) %>%
  dplyr::summarise(quantity = sum(quantity, na.rm=TRUE)) %>%
  arrange(desc(quantity)) 

DT::datatable(quantity, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 1: ', 
                htmltools::em('Quantity per unit'))) %>%
  formatRound('quantity',1) 

rm(units, quantity)
```
### import_export
**It represents Whether the shipment is an (I)mport or (E)xport**. In this dataset, 100% of the data is an import. 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
imports <-data %>% group_by(import_export) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  arrange(desc(percentage)) 

DT::datatable(imports, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 2: ', 
                htmltools::em('Shipments: Imports and exports'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
imports %>% mutate(percentage=percentage*100) %>%
plot_ly(x=~reorder(import_export, desc(percentage)), y=~percentage, color=~import_export) %>% 
  add_bars() %>%
  layout(title = "<b>Shipments: Imports and exports</b>",
         xaxis= list(title= "<b>Imports and exports</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))
                       
rm(imports)
```

### action
**Action taken by the USFWS on import ((C)leared/(R)efused)**

- 98.28% of imports were legally declared, just 1.73% was refused. We can find cleared and refused segments in the same unique shipment. 
- Most of the refused shipments included items related with mammals (28%) and reptils (27%)
- Most illegal shipments are exported from Mexico (19%), Canada (9%) and China (8%).  
- The country of origin of the refused shipments is mainly unknown (23%), followed by Mexico (14%), Canada (6%), Indonesia (6% )and China (6%)


```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
action <-data %>% group_by(action) %>%
  summarise(total= n(), percentage=n()/nrow(data)) %>%
  drop_na(action) %>%
  arrange(desc(percentage)) 

DT::datatable(action, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 3: ', 
                htmltools::em('Action taken by the USFWS on imports'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
action %>% mutate(percentage=percentage*100) %>%
plot_ly(x=~reorder(action, desc(percentage)), y=~percentage, color=~action) %>% 
  add_bars() %>%
  layout(title = "<b>Action taken by the USFWS on imports</b>",
         xaxis= list(title= "<b>Actions</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(action)
```


```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
refused <- data %>% filter(action=="Refused")

# Country of origin
refused %>% group_by(country_origin) %>%
  summarise(total=n(), percentage=n()/nrow(refused)*100) %>%
  arrange(desc(percentage)) %>%
  top_n(15, percentage) %>%
  plot_ly(x=~reorder(country_origin, desc(percentage)), y=~percentage, 
          color=~country_origin) %>%
  add_bars() %>%
  layout(title = "<b>Country of origin of refused segments (Top 15)</b>",
         xaxis= list(title= "<b>Country of origin</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

# Country of export
refused %>% group_by(country_imp_exp) %>%
  summarise(total=n(), percentage=n()/nrow(refused)*100) %>%
  arrange(desc(percentage)) %>%
  top_n(15, percentage) %>%
  plot_ly(x=~reorder(country_imp_exp, desc(percentage)), y=~percentage, 
          color=~country_imp_exp) %>%
  add_bars() %>%
  layout(title = "<b>Country of export of refused segments (Top 15)</b>",
         xaxis= list(title= "<b>Country of export</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

# Taxa
refused %>% group_by(taxa) %>%
  summarise(total=n(), percentage=n()/nrow(refused)*100) %>%
  arrange(desc(percentage)) %>%
  top_n(15, percentage) %>%
  plot_ly(x=~reorder(taxa, desc(percentage)), y=~percentage, 
          color=~taxa) %>%
  add_bars() %>%
  layout(title = "<b>Taxa of refused segments (Top 15)</b>",
         xaxis= list(title= "<b>Taxa</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

# Genus
refused %>% 
  drop_na(genus) %>%
  mutate(genus=paste(taxa,"-", genus)) %>%
  group_by(genus) %>%
  summarise(total=n(), percentage=n()/nrow(refused)*100) %>%
  arrange(desc(percentage)) %>%
  top_n(15, percentage) %>%
  plot_ly(x=~reorder(genus, desc(percentage)), y=~percentage, 
          color=~genus) %>%
  add_bars() %>%
  layout(title = "<b>Figure 37:Genus of refused segments (Top 15)</b>",
         xaxis= list(title= "<b>Genus</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

# Port
refused %>% 
  group_by(port) %>%
  summarise(total=n(), percentage=n()/nrow(refused)*100) %>%
  arrange(desc(percentage)) %>%
  top_n(15, percentage) %>%
  plot_ly(x=~reorder(port, desc(percentage)), y=~percentage, 
          color=~port) %>%
  add_bars() %>%
  layout(title = "<b>Port of refused segments (Top 15)</b>",
         xaxis= list(title= "<b>Port</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(refused)
```

### disposition
**It represents the fate of the import**

- There are 5 categories: Cleared, abandoned, reexport, seized and others. 
- Most of them (98.3%) are cleared. 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
disposition <-data %>% group_by(disposition) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(disposition) %>%
  arrange(desc(percentage)) 

DT::datatable(disposition, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 4: ', 
                htmltools::em('Fate of the import'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
disposition %>% mutate(percentage=percentage*100) %>%
plot_ly(x=~reorder(disposition, desc(percentage)), y=~percentage, color=~disposition) %>% 
  add_bars() %>%
  layout(title = "<b>Fate of the import</b>",
         xaxis= list(title= "<b>Dispositions</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(disposition)
                       
```
### shipment_date and disposition_date
**Shipment_date** represents the date when shipment arrived, while **disposition_date** represents the date when disposition occurred. 

**54% of dispositions took place within a month of the shipment date (most of them within a week)**

- While ‘shipment_date’ entries fell completely within the time period of 2000–2014, ‘disposition_date’ ranged more widely 
- Users should be wary of any disposition date values that precede the associated shipment date, as we are unaware of how this could represent an accurate accounting of the product disposition process. However, for many potential analyses, differences in the date fields may not be a significant cause for concern because ‘shipment_date’ alone provides a sound index for those interested in temporal trends in wildlife trade

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
days<- data %>% 
  mutate(days = as.factor(as.numeric(disposition_date - shipment_date))) %>%
  group_by(days) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>% 
  filter(days %in% c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10",
                     "11", "12", "13", "14", "15", "16", "17", "18", "19", "20",
                     "21", "22", "23", "24", "25", "26", "27", "28", "29", "30")) 

DT::datatable(days, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 5: ', 
                htmltools::em('Number of dispositions within a month of the shipment date'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
days %>% mutate(percentage=percentage*100) %>%
plot_ly(x=~reorder(days, percentage), y=~percentage) %>% 
  add_bars() %>%
  layout(title = "<b>Percentage of dispositions within a month of the shipment date</b>",
         xaxis= list(title= "<b>Days</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(days)
```

## Variables related with the countries
### country_origin
**It represents the code for the country of origin of the wildlife product**. Shipments comes from 252 different countries of origin, although 75% of all the segments comes from the same 15 countries.The top-five countries of origin were Indonesia (15%), Canada (10%), South Africa (9%), Philippines (8%) and China (7%). Together, they represent around 50% of all segments.

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$country_origin <- droplevels(data$country_origin)

country_origin <-data %>% group_by(country_origin) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(country_origin) %>%
  arrange(desc(percentage)) 

DT::datatable(country_origin, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 6: ', 
                htmltools::em('Country of origin of the wildlife product'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
country_origin %>% mutate(percentage=percentage*100) %>%
  top_n(15, percentage) %>%
  plot_ly(x=~reorder(country_origin, desc(percentage)), y=~percentage, 
        color=~country_origin) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 10: Country of origin of the wildlife product (Top 15)</b>",
         xaxis= list(title= "<b>Country of origin</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))


```


```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Country of origin by quantity
# We'll only include in the analysis those items measured in "number" and "kg" units, because they represent 99.45% of the data. 

data %>% 
  filter(unit=="Number") %>%
  group_by(country_origin, unit) %>%
  summarise(total = sum(quantity))  %>%
  arrange(desc(total)) %>%
  ungroup() %>%
  top_n(15, total) %>%
  plot_ly(x=~reorder(country_origin, desc(total)), y=~total, 
        color=~country_origin) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 12: Most common country of origin (by number) (Top 15)</b>",
         xaxis= list(title= "<b>Country of origin</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))

data %>% 
  filter(unit=="Kilograms") %>%
  group_by(country_origin, unit) %>%
  summarise(total = sum(quantity))  %>%
  arrange(desc(total)) %>%
  ungroup() %>%
  top_n(15, total) %>%
  plot_ly(x=~reorder(country_origin, desc(total)), y=~total, 
        color=~country_origin) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 13: Most common country of origin (by Kilograms) (Top 15)</b>",
         xaxis= list(title= "<b>Country of origin</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))

```

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
country_origin_top5<- data %>%
  filter(country_origin %in% c("Indonesia", "Canada", "South Africa", 
                            "Philippines", "China")) %>%
  group_by(country_origin, taxa) %>%
  dplyr::summarise(n=n()) %>%
  mutate(percentage = n/sum(n)*100) %>%
  arrange(country_origin, desc(percentage)) %>%
  top_n(3, percentage)

country_origin_top5<- droplevels(country_origin_top5)

plot_ly(country_origin_top5, x=~country_origin, 
                            y=~percentage, group= ~taxa, 
                            type="bar", color=~taxa) %>%
  layout(title = "<b>Figure 11: Common taxa by country of origin</b>",
         xaxis= list(title= "<b>Country of origin</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))

rm(country_origin_top5)
```

### country_imp_exp
**It represents the code for the country to/from which the wildlife product is shipped**.
**Shipments were exported to the UUEE from 257 different countries, although the top 15 represent 75% of all segments.** The top-five countries of export were Canada (12%), Indonesia (12%), South Africa (8%), Philippines (8%) and Italy (7%).

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$country_imp_exp <- droplevels(data$country_imp_exp)

country_imp_exp <-data %>% group_by(country_imp_exp) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(country_imp_exp) %>%
  arrange(desc(percentage)) 

DT::datatable(country_imp_exp, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 7: ', 
                htmltools::em('Country to/from which the wildlife product is shipped'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
country_imp_exp %>% mutate(percentage=percentage*100) %>%
  top_n(15, percentage) %>%
  plot_ly(x=~reorder(country_imp_exp, desc(percentage)), y=~percentage, 
        color=~country_imp_exp) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 14: Country that exported the wildlife product to the EEUU (Top 15)</b>",
         xaxis= list(title= "<b>country_imp_exp</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

```

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Country of export by quantity
# We'll only include in the analysis those items measured in "number" and "kg" units, because they represent 99.45% of the data. 

data %>% 
  filter(unit=="Number") %>%
  group_by(country_imp_exp, unit) %>%
  summarise(total = sum(quantity))  %>%
  arrange(desc(total)) %>%
  ungroup() %>%
  top_n(15, total) %>%
  plot_ly(x=~reorder(country_imp_exp, desc(total)), y=~total, 
        color=~country_imp_exp) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 16: Most common country of export (by number) (Top 15)</b>",
         xaxis= list(title= "<b>Country of export</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))

data %>% 
  filter(unit=="Kilograms") %>%
  group_by(country_imp_exp, unit) %>%
  summarise(total = sum(quantity))  %>%
  arrange(desc(total)) %>%
  ungroup() %>%
  top_n(15, total) %>%
  plot_ly(x=~reorder(country_imp_exp, desc(total)), y=~total, 
        color=~country_imp_exp) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 17: Most common country of export (by Kilograms) (Top 15)</b>",
         xaxis= list(title= "<b>Country of export</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))

```

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
country_export_top5<- data %>%
  filter(country_imp_exp %in% c("Canada", "Indonesia", "South Africa", 
                            "Philippines", "Italy")) %>%
  group_by(country_imp_exp, taxa) %>%
  dplyr::summarise(n=n()) %>%
  mutate(percentage = n/sum(n)*100) %>%
  arrange(country_imp_exp, desc(percentage)) %>%
  top_n(3, percentage)

country_export_top5<- droplevels(country_export_top5)

plot_ly(country_export_top5, x=~country_imp_exp, 
                            y=~percentage, group= ~taxa, 
                            type="bar", color=~taxa) %>%
  layout(title = "<b>Figure 15: Common taxa by country of export</b>",
         xaxis= list(title= "<b>Country of export</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))

rm(country_export_top5)
```

**Most active countries are on both sides (country of origin & country of export)**
```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}

country_origin <- country_origin %>%
  mutate(percentage=percentage*100) %>% top_n(4, percentage) %>%
  rename(country = country_origin)

country_imp_exp <- country_imp_exp %>%
  mutate(percentage=percentage*100) %>% top_n(4, percentage) %>%
  rename(country = country_imp_exp)

countries<- combine(country_origin, country_imp_exp) 

countries %>%
  plot_ly(x=~reorder(country, desc(percentage)), y=~percentage, 
        color=~source) %>% 
  add_bars() %>%
  layout(title = "<b>Most active countries</b>",
         xaxis= list(title= "<b>Country</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(country_origin)
rm(country_imp_exp)
rm(countries)
```

### port
**It represents the port of entry**
Although [there are around 328 ports of entry into the EEUU](https://www.cbp.gov/), only 73 of them are represented in this dataset. This is because not all of them are covered by FWS wildlife inspectors. By law, [only 18 of them are designated ports with  full-time inspectors](https://www.fws.gov/le/wildlife-inspectors.html).

Based on the number of segments, the top-five ports of entry were Los Angeles (20%), New York(19%), Miami(6%), Newark(5%) and San Francisco(5%). Together, they represent 56% of all segments. The top 15 represent 84% of all segments. It's interesting to point out that the top-five ports of entry are all designated ports. 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$port <- droplevels(data$port)

port <-data %>% group_by(port) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(port) %>%
  arrange(desc(percentage))

DT::datatable(port, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 8: ', 
                htmltools::em('Port or region of shipment entry'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
port %>% mutate(percentage=percentage*100) %>%
  top_n(15, percentage) %>%
  plot_ly(x=~reorder(port, desc(percentage)), y=~percentage, 
        color=~port) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 18: Port of entry (Top 15)</b>",
         xaxis= list(title= "<b>Port</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(port)
```

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Ports by quantity
# We'll only include in the analysis those items measured in "number" and "kg" units, because they represent 99.45% of the data. 

data %>% 
  filter(unit=="Number") %>%
  group_by(port, unit) %>%
  summarise(total = sum(quantity))  %>%
  arrange(desc(total)) %>%
  ungroup() %>%
  top_n(15, total) %>%
  plot_ly(x=~reorder(port, desc(total)), y=~total, 
        color=~port) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 20: Most common ports (by number) (Top 15)</b>",
         xaxis= list(title= "<b>Port</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))

data %>% 
  filter(unit=="Kilograms") %>%
  group_by(port, unit) %>%
  summarise(total = sum(quantity))  %>%
  arrange(desc(total)) %>%
  ungroup() %>%
  top_n(15, total) %>%
  plot_ly(x=~reorder(port, desc(total)), y=~total, 
        color=~port) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 21: Most common ports (by Kilograms) (Top 15)</b>",
         xaxis= list(title= "<b>Port</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))


```


```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
ports_top5<- data %>%
  filter(port %in% c("Los Angeles, CA", "New York, NY", "Miami, FL", 
                            "Newark, NJ", "San Francisco, CA")) %>%
  group_by(port, taxa) %>%
  dplyr::summarise(n=n()) %>%
  mutate(percentage = n/sum(n)*100) %>%
  arrange(port, desc(percentage)) %>%
  top_n(3, percentage)

ports_top5<- droplevels(ports_top5)

plot_ly(ports_top5, x=~port, 
                            y=~percentage, group= ~taxa, 
                            type="bar", color=~taxa) %>%
  layout(title = "<b>Figure 19: Common taxa by port</b>",
         xaxis= list(title= "<b>Port</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))

rm(ports_top5)
```

### Trade routes
```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}

trade_routes <-data %>% group_by(country_imp_exp, port) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(port, country_imp_exp) %>%
  arrange(desc(percentage))

DT::datatable(trade_routes, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 8: ', 
                htmltools::em('Trade routes'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
rm(trade_routes, port)
```

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
routes_top5<- data %>%
  mutate(route = paste(country_imp_exp,"-", port)) %>%
  filter(route %in% c("Indonesia - Los Angeles, CA", 
                      "Italy - New York, NY", 
                      "South Africa - New York, NY", 
                      "Hong Kong SAR China - New York, NY",
                      "Philippines - Los Angeles, CA")) %>%
  group_by(route, taxa) %>%
  dplyr::summarise(n=n()) %>%
  mutate(percentage = n/sum(n)*100) %>%
  arrange(route, desc(percentage)) %>%
  top_n(3, percentage)

routes_top5<- droplevels(routes_top5)

plot_ly(routes_top5, x=~route, 
                            y=~percentage, group= ~taxa, 
                            type="bar", color=~taxa) %>%
  layout(title = "<b>Figure 22: Common taxa by route</b>",
         xaxis= list(title= "<b>Route</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))

rm(routes_top5)
```


### us_co
**It represents the US party of the shipment**

- We have excluded the "EXEMPTIONS 6 AND 7(C)" from the analysis. 
- There are 126,052 US parties 
- The top 15 just represents 10.3% of data 
- The top 50 just represents 19 % of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
us_co <-data %>% 
  filter(!us_co == "EXEMPTIONS 6 AND 7(C)") %>%
  group_by(us_co) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(us_co) %>%
  arrange(desc(percentage)) 

DT::datatable(us_co, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 9: ', 
                htmltools::em('US party of the shipment'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
us_co %>% mutate(percentage=percentage*100) %>%
  top_n(20, percentage) %>%
  plot_ly(x=~reorder(us_co, desc(percentage)), y=~percentage, 
        color=~us_co) %>% 
  add_bars() %>%
  layout(title = "<b>US party of the shipment (Top 20)</b>",
         xaxis= list(title= "<b>US party</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(us_co)
```

We want to analyze which American corporations are importing the most. So, we have grouped the mayor corporations based on the company names. 

We’ve grouped most of those companies that represent at least 19% of the data, covering approximately 1.000.000 observations.

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE, out.width='90%'}

# Let's summarize and graph these corporations
data_corporations<- data %>% 
  filter(corp_classif!="Others") %>%
  group_by(corp_classif, corporation) %>%
  dplyr::summarise(total=n(), percentage=n()/nrow(data)) %>%
  arrange(desc(total)) 
  

DT::datatable(data_corporations, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 10: ', 
                htmltools::em('Which American corporations are importing the most'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
## Graph by classification
data_corporations %>% mutate(percentage=percentage*100) %>%
  filter(corp_classif == "Fashion/Luxury/Design") %>%
  plot_ly(x=~reorder(corporation, desc(percentage)), y=~percentage, 
         marker = list(color = "coral")) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 23: Fashion/Luxury/Design Corporations</b>",
         xaxis= list(title= "<b>American corporation</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

data_corporations %>% mutate(percentage=percentage*100) %>%
  filter(corp_classif == "Animal/animal prod. providers") %>%
  plot_ly(x=~reorder(corporation, desc(percentage)), y=~percentage, 
         marker = list(color = "green")) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 24: Animal/animal prod. providers Corporations</b>",
         xaxis= list(title= "<b>American corporation</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

data_corporations %>% 
  group_by(corp_classif) %>%
  dplyr::summarise(total=sum(total), percentage=sum(percentage)) %>%
  mutate(percentage=percentage*100) %>%
  plot_ly(x=~reorder(corp_classif, desc(percentage)), y=~percentage, 
  color=~corp_classif) %>%  add_bars() %>%
  layout(title = "<b>American corporation classification </b>",
         xaxis= list(title= "<b>American corporation</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(data_corporations)
```

### foreign_co
**It represents the foreign party of the shipment**

- There are 237,994 foreign parties 
- The top 15 just represents  5.4% of data 
- The top 50 just represents 12.4% of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
foreign_co <-data %>% 
  filter(!foreign_co == "EXEMPTIONS 6 AND 7(C)") %>%
  group_by(foreign_co) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(foreign_co) %>%
  arrange(desc(percentage)) 

DT::datatable(foreign_co, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 11: ', 
                htmltools::em('Foreign party of the shipment'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
foreign_co %>% mutate(percentage=percentage*100) %>%
  top_n(20, percentage) %>%
  plot_ly(x=~reorder(foreign_co, desc(percentage)), y=~percentage, 
        color=~foreign_co) %>% 
  add_bars() %>%
  layout(title = "<b>Foreign party of the shipment (Top 20)</b>",
         xaxis= list(title= "<b>Foreign party of the shipment</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(foreign_co)
```

## Variables related with the product
### description
**It represents the type/form of the wildlife product**. The FWS Import/Export Key recognizes 94 different descriptions for wildlife items, although only 87 of them were used in this dataset. 

**Based on the types of items by segment**, most of them contain "Live specimens" (29%), followed by trophies (17%), "shell products" (9%), small leather products (7%) and jewelry (6%). Together, the top-five descriptions represent 68% of all segments. 

- Most of the "live specimens" are corals (38%) and fishes (23%)
- Most of the "trophies" are made from mammals (89%)
- Most of the "shell products" are derived from shells (98%)
- Most of the "small leather products" are derived from reptiles (81%) 
- Most of the "jewelry" is derived from shells (93%)

**If we take into account the quantity of items in trade (instead of the type of segment): Based on the number of items**, jewelry, shells, feathers, hair products and eggs (dead or blown) are the most common products. And **based on the kg of items**, meat, dead animals, frog legs, live specimens and shells are the most common products.


```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}

# Dropping unused levels
data$description <- droplevels(data$description)
                       
description <-data %>% 
  group_by(description) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(description) %>%
  arrange(desc(percentage)) 

DT::datatable(description, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 12: ', 
                htmltools::em('Type/form of the wildlife product'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)

description %>% mutate(percentage=percentage*100) %>%
  top_n(15, percentage) %>%
  plot_ly(x=~reorder(description, desc(percentage)), y=~percentage, 
        color=~description) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 1: Common types of items by segment (Top 15)</b>",
         xaxis= list(title= "<b>Description</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(description)
```
```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Descriptions by quantity
# We'll only include in the analysis those items measured in "number" and "kg" units, because they represent 99.45% of the data. 

data %>% 
  filter(unit=="Number") %>%
  group_by(description, unit) %>%
  summarise(total = sum(quantity))  %>%
  arrange(desc(total)) %>%
  ungroup() %>%
  top_n(15, total) %>%
  plot_ly(x=~reorder(description, desc(total)), y=~total, 
        color=~description) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 3: Most common type of items (by number) (Top 15)</b>",
         xaxis= list(title= "<b>Description</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))

data %>% 
  filter(unit=="Kilograms") %>%
  group_by(description, unit) %>%
  summarise(total = sum(quantity))  %>%
  arrange(desc(total)) %>%
  ungroup() %>%
  top_n(15, total) %>%
  plot_ly(x=~reorder(description, desc(total)), y=~total, 
        color=~description) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 4: Most common type of items (by Kilograms) (Top 15)</b>",
         xaxis= list(title= "<b>Description</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))
  

```


```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
descriptions_top5<- data %>%
  filter(description %in% c("Live specimen", "Trophy", "Shell product", 
                            "Leather product (small)", "Jewelry")) %>%
  group_by(description, taxa) %>%
  dplyr::summarise(n=n()) %>%
  mutate(percentage = n/sum(n)*100) %>%
  arrange(description, desc(percentage)) %>%
  top_n(3, percentage)

descriptions_top5<- droplevels(descriptions_top5)

plot_ly(descriptions_top5, x=~description, 
                            y=~percentage, group= ~taxa, 
                            type="bar", color=~taxa) %>%
  layout(title = "<b>Figure 2: Common taxa by description</b>",
         xaxis= list(title= "<b>Description</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))

rm(descriptions_top5)
```

### value
**It represents the reported value of every shipment in US dollars**. 
- Lower values are more common than higher values
- The min value is 0 dollars while the max value is 118,000,000 dollars   
- The halway point, the median, is 187$ 
- 50% of shipments are between 30 dollars (1st quartile) and 1260 dollars (3rd quartile)


```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
summary(data$value)

# Data between the minimum value and the 3rd quartile
data %>% 
  filter(value>=0 & value<=1260) %>%
  plot_ly(x=~value, type='histogram', nbinsx = 40) %>%
  layout(title = "<b>Number of shipments with a value between 0 and 1260 US dollars.</b>",
         xaxis= list(title= "<b>Value</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Count</b>"))

```

### purpose
**It represents the declared reason the wildlife product is being imported**. It's declared by the importer. The FWS Import/Export Key recognizes 12 different purposes of import and all of them were used in this dataset. 

**Based on the types of items by segment**, most of them were imported for "Commercial" (75%) and "hunting trophies" (18%) purposes. Together, both purposes represent 92% of all segments

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$purpose <- droplevels(data$purpose)

purpose <-data %>% 
  group_by(purpose) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(purpose) %>%
  arrange(desc(percentage)) 

DT::datatable(purpose, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 13: ', 
                htmltools::em('Reasons the wildlife products are being imported'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
purpose %>% mutate(percentage=percentage*100) %>%
  plot_ly(x=~reorder(purpose, desc(percentage)), y=~percentage, 
        color=~purpose) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 5: Reasons the wildlife products are being imported</b>",
         xaxis= list(title= "<b>Purposes</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(purpose)
```

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Purpose  by quantity
# We'll only include in the analysis those items measured in "number" and "kg" units, because they represent 99.45% of the data. 

data %>% 
  filter(unit=="Number") %>%
  group_by(purpose, unit) %>%
  summarise(total = sum(quantity))  %>%
  arrange(desc(total)) %>%
  ungroup() %>%
  top_n(15, total) %>%
  plot_ly(x=~reorder(purpose, desc(total)), y=~total, 
        color=~purpose) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 7: Most common type of purpose (by number) </b>",
         xaxis= list(title= "<b>Purpose </b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))

data %>% 
  filter(unit=="Kilograms") %>%
  group_by(purpose, unit) %>%
  summarise(total = sum(quantity))  %>%
  arrange(desc(total)) %>%
  ungroup() %>%
  top_n(15, total) %>%
  plot_ly(x=~reorder(purpose, desc(total)), y=~total, 
        color=~purpose) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 8: Most common type of purpose (by Kilograms)</b>",
         xaxis= list(title= "<b> Purpose</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))
  

```

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
purpose_taxa<- data %>%
  filter(purpose %in%  c("Commercial", "Hunting trophies", "Personal", 
                            "Scientific", "Educational")) %>%
  group_by(purpose, taxa) %>%
  dplyr::summarise(n=n()) %>%
  mutate(percentage = n/sum(n)*100) %>%
  arrange(purpose, desc(percentage)) %>%
  top_n(3, percentage)

purpose_taxa<- droplevels(purpose_taxa)

plot_ly(purpose_taxa, x=~purpose, 
                            y=~percentage, group= ~taxa, 
                            type="bar", color=~taxa) %>%
  layout(title = "<b>Figure 6: Common taxa by purpose</b>",
         xaxis= list(title= "<b>Purpose</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))

rm(purpose_taxa)
```

### source
**It represents the type of source within the origin country (e.g., wild, bred)**. The FWS Import/Export Key recognizes 10 different sources for wildlife items, although only 8 of them were used in this dataset. 

**Based on the source of the items by segment**, the most common sources in the segments are "specimens taken from the wild" (78%) and "animals bred in captivity" (15%). Together, both represent around 93% of all segments (Figure 10)..

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$source <- droplevels(data$source)

source <-data %>% 
  group_by(source) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(source) %>%
  arrange(desc(percentage)) 

DT::datatable(source, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 14: ', 
                htmltools::em('Types of source within the origin country'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
source %>% mutate(percentage=percentage*100) %>%
  plot_ly(x=~reorder(source, desc(percentage)), y=~percentage, 
        color=~source) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 9: Types of source within the origin country</b>",
         xaxis= list(title= "<b>Sources</b>" ,tickangle=-65, tickfont = list(size = 10)),
         yaxis = list(title = "<b>Percentage</b>"))

rm(source)
```

### species_code
**It represents the USFWS code for the wildlife product**

- There are 15, 322 unique species codes 
- The top 15 represents 30 % of data 
- The top 50 represents 50.4% of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$species_code <- droplevels(data$species_code)

species_code <-data %>% 
  group_by(species_code) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(species_code) %>%
  arrange(desc(percentage)) 

DT::datatable(species_code, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 15: ', 
                htmltools::em('USFWS code for the wildlife product'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
species_code %>% mutate(percentage=percentage*100) %>%
  top_n(15, percentage) %>%
  plot_ly(x=~reorder(species_code, desc(percentage)), y=~percentage, 
        color=~species_code) %>% 
  add_bars() %>%
  layout(title = "<b>USFWS code for the wildlife product (Top 15)</b>",
         xaxis= list(title= "<b>USFWS code</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(species_code)
```

### taxa
**It represents the USFWS-derived broad taxonomic categorization**

- There are 13 taxa levels
- There is a ‘taxa’ field for the vast majority (>99%) of records
- Most of them are mammals (29.16%), followed by shells (20.34%), reptiles (13.29%) and corals (12.63%). These four categories represent 75,42% of data

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$taxa <- droplevels(data$taxa)

taxa <-data %>% 
  group_by(taxa) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(taxa) %>%
  arrange(desc(percentage)) 

DT::datatable(taxa, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 16: ', 
                htmltools::em('USFWS-derived broad taxonomic categorization'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
taxa %>% mutate(percentage=percentage*100) %>%
  plot_ly(x=~reorder(taxa, desc(percentage)), y=~percentage, 
        color=~taxa) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 25: USFWS-derived broad taxonomic categorization</b>",
         xaxis= list(title= "<b>Taxa</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))
rm(taxa)
```


```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Taxa  by quantity
# We'll only include in the analysis those items measured in "number" and "kg" units, because they represent 99.45% of the data. 

data %>% 
  filter(unit=="Number") %>%
  group_by(taxa, unit) %>%
  summarise(total = sum(quantity))  %>%
  arrange(desc(total)) %>%
  ungroup() %>%
  plot_ly(x=~reorder(taxa, desc(total)), y=~total, 
        color=~taxa) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 26: Most common type of taxa (by number) </b>",
         xaxis= list(title= "<b>Taxa </b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))

data %>% 
  filter(unit=="Kilograms") %>%
  group_by(taxa, unit) %>%
  summarise(total = sum(quantity))  %>%
  arrange(desc(total)) %>%
  ungroup() %>%
  plot_ly(x=~reorder(taxa, desc(total)), y=~total, 
        color=~taxa) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 27: Most common type of taxa (by Kilograms)</b>",
         xaxis= list(title= "<b> Taxa </b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))


```


### class
**It represents the EHA-derived class-level taxonomic designation**
- There are 53 classes
- The top 15 represents 93% of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$class <- droplevels(data$class)

class <-data %>% 
  group_by(class) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(class) %>%
  arrange(desc(percentage)) 

DT::datatable(class, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 17: ', 
                htmltools::em(' EHA-derived class-level taxonomic designation'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
class %>% mutate(percentage=percentage*100) %>%
  top_n(20, percentage) %>%
  plot_ly(x=~reorder(class, desc(percentage)), y=~percentage, 
        color=~class) %>% 
  add_bars() %>%
  layout(title = "<b>EHA-derived class-level taxonomic designation (Top 20)</b>",
         xaxis= list(title= "<b>Class</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(class)
```

### genus
**It represents the Genus (or higher-level taxonomic name) of the wildlife product**

- There are 6,335 genus levels 
- The top 15 represents 33.4 of data
- The top 50 represents 57.3% of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$genus <- droplevels(data$genus)

genus <-data %>% 
  group_by(genus) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(genus) %>%
  arrange(desc(percentage)) 

DT::datatable(genus, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 18: ', 
                htmltools::em('Genus (or higher-level taxonomic name) of the wildlife product'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
genus %>% mutate(percentage=percentage*100) %>%
  top_n(15, percentage) %>%
  plot_ly(x=~reorder(genus, desc(percentage)), y=~percentage, 
        color=~genus) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 28: Genus (or higher-level taxonomic name) of the wildlife product (Top 15)</b>",
         xaxis= list(title= "<b>Genus</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(genus)
```

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
genus_species<- data %>%
  filter(genus %in% c("Pinctada", "Alligator", "Ursus", "Python", "Mustela")) %>%
  group_by(genus, species) %>%
  dplyr::summarise(n=n()) %>%
  mutate(percentage = n/sum(n)*100) %>%
  arrange(genus, desc(percentage))  %>%
  top_n(3, percentage)

genus_species<- droplevels(genus_species)

plot_ly(genus_species, x=~genus, 
                            y=~percentage, group= ~species, 
                            type="bar", color=~species) %>%
  layout(title = "<b>Figure 29: Common species by genus</b>",
         xaxis= list(title= "<b>Genus</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))


genus_description<- data %>%
  filter(genus %in% c("Pinctada", "Alligator", "Ursus", "Python", "Mustela")) %>%
  group_by(genus, description) %>%
  dplyr::summarise(n=n()) %>%
  mutate(percentage = n/sum(n)*100) %>%
  arrange(genus, desc(percentage)) %>%
  top_n(3, percentage)

rm(genus_species,genus_description)

```
```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Genus  by quantity
# We'll only include in the analysis those items measured in "number" and "kg" units, because they represent 99.45% of the data. 

data %>% 
  filter(unit=="Number") %>%
  group_by(genus, unit) %>%
  summarise(total = sum(quantity))  %>%
  arrange(desc(total)) %>%
  ungroup() %>%
  top_n(15, total) %>%
  plot_ly(x=~reorder(genus, desc(total)), y=~total, 
        color=~genus) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 30: Most common type of genus (by number) </b>",
         xaxis= list(title= "<b> Genus </b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))

data %>% 
  filter(unit=="Kilograms") %>%
  group_by(genus, unit) %>%
  summarise(total = sum(quantity))  %>%
  arrange(desc(total)) %>%
  ungroup() %>%
  top_n(15, total) %>%
  plot_ly(x=~reorder(genus, desc(total)), y=~total, 
        color=~genus) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 31: Most common type of genus (by Kilograms)</b>",
         xaxis= list(title= "<b> Genus </b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))


```

### species
**It represents species of the wildlife product**. To get a more ilustrative name, we'll combine genus and species. 

- After removing generics, there are 8,082 different species
- The top 15 represents 23.8 % of data
- The top 50 represents 38.3 % of data

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$species <- droplevels(data$species)

# Removing generics
species<- data %>%
  filter(!species %in% c("maxima", "sp.", "in trop fish &", "(marine sp.)",
                        "(freshwater sp.)", "(including goldfish)")) %>%
  drop_na(species)
  
# Combine genus + species
species <- species %>% mutate(species = as.factor(paste(genus, "-",species)))

species <-species %>% 
  group_by(species) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(species) %>%
  arrange(desc(percentage)) 

DT::datatable(species, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 19: ', 
                htmltools::em('Species of the wildlife product'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
species %>% mutate(percentage=percentage*100) %>%
  top_n(15, percentage) %>%
  plot_ly(x=~reorder(species, desc(percentage)), y=~percentage, 
        color=~species) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 32: Species of the wildlife product (Top 15)</b>",
         xaxis= list(title= "<b>Species</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))


# Combine genus + species in the dataset
data <- data %>% mutate(species = as.factor(paste(genus, "-",species)))

rm(species)
```

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
species_description<- data %>%
  filter(species %in% c("Alligator - mississippiensis", "Ursus - americanus", 
                      "Mustela - vison", "Struthio - camelus", 
                      "Pinctada - margaritifera")) %>%
  group_by(species, description) %>%
  dplyr::summarise(n=n()) %>%
  mutate(percentage = n/sum(n)*100) %>%
  arrange(species, desc(percentage)) %>%
  top_n(3, percentage)

species_description<- droplevels(species_description)

plot_ly(species_description, x=~species, 
                            y=~percentage, group= ~description, 
                            type="bar", color=~description) %>%
  layout(title = "<b>Figure 33: Common descriptions by species</b>",
         xaxis= list(title= "<b>Species</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))

species_source<- data %>%
  filter(species %in% c("Alligator - mississippiensis", "Ursus - americanus", 
                      "Mustela - vison", "Struthio - camelus", 
                      "Pinctada - margaritifera")) %>%
  group_by(species, source) %>%
  dplyr::summarise(n=n()) %>%
  mutate(percentage = n/sum(n)*100) %>%
  arrange(species, desc(percentage)) %>%
  top_n(3, percentage)

species_source<- droplevels(species_source)

plot_ly(species_source, x=~species, 
                            y=~percentage, group= ~source, 
                            type="bar", color=~source) %>%
  layout(title = "<b>Figure 34: Common sources by species</b>",
         xaxis= list(title= "<b>Species</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))


rm(species_description,species_source)
```

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Species  by quantity
# We'll only include in the analysis those items measured in "number" and "kg" units, because they represent 99.45% of the data. 

data %>% 
  filter(!grepl('maxima|sp.|in trop fish &|(marine sp.)|
                (freshwater sp.)|(including goldfish)|NA - NA', species)) %>%
  filter(unit=="Number") %>%
  group_by(species, unit) %>%
  summarise(total = sum(quantity))  %>%
  arrange(desc(total)) %>%
  ungroup() %>%
  top_n(15, total) %>%
  plot_ly(x=~reorder(species, desc(total)), y=~total, 
        color=~species) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 35: Most common type of species (by number) </b>",
         xaxis= list(title= "<b> Species </b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))

data %>% 
  filter(!grepl('maxima|sp.|in trop fish &|(marine sp.)|
                (freshwater sp.)|(including goldfish)|NA - NA', species)) %>%
  filter(unit=="Kilograms") %>%
  group_by(species, unit) %>%
  summarise(total = sum(quantity))  %>%
  arrange(desc(total)) %>%
  ungroup() %>%
  top_n(15, total) %>%
  plot_ly(x=~reorder(species, desc(total)), y=~total, 
        color=~species) %>% 
  add_bars() %>%
  layout(title = "<b>Figure 36: Most common type of species (by Kilograms)</b>",
         xaxis= list(title= "<b> Species </b>" ,tickangle=-65),
         yaxis = list(title = "<b>Total</b>"))

```

### subspecies
**It represents subspecies of the wildlife product**

- There are 439 subspecies levels 
- The top 15 just represents 2.5% of data 
- The top 50 just represents 2.6% of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$subspecies <- droplevels(data$subspecies)

subspecies <-data %>% 
  group_by(subspecies) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  filter(subspecies!="other shipments") %>%
  drop_na(subspecies) %>%
  arrange(desc(percentage))

DT::datatable(subspecies, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 20: ', 
                htmltools::em('Subespecies of the wildlife product'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
subspecies %>% mutate(percentage=percentage*100) %>%
  top_n(20, percentage) %>%
  plot_ly(x=~reorder(subspecies, desc(percentage)), y=~percentage, 
        color=~subspecies) %>% 
  add_bars() %>%
  layout(title = "<b>Subespecies of the wildlife product (Top 20)</b>",
         xaxis= list(title= "<b>Subespecies</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(subspecies)

```
### generic_name
**It represents a general common name for the wildlife product**

- There are 1,987 generic names levels 
- The top 15 represents 49.3% of data 
- The top 50 represents 71.6% of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$generic_name <- droplevels(data$generic_name)

generic_name <-data %>% 
  group_by(generic_name) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(generic_name) %>%
  arrange(desc(percentage))

DT::datatable(generic_name, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 21: ', 
                htmltools::em('General common names for the wildlife product'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
generic_name %>% mutate(percentage=percentage*100) %>%
  top_n(20, percentage) %>%
  plot_ly(x=~reorder(generic_name, desc(percentage)), y=~percentage, 
        color=~generic_name) %>% 
  add_bars() %>%
  layout(title = "<b>General common names for the wildlife product (Top 20)</b>",
         xaxis= list(title= "<b>Generic Name</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(generic_name)
```

### specific_name
**It represents a specific common name for the wildlife product**. For getting a more ilustrative name, we'll combine generic_name and specific_name 

- After removing empty values, there are 10,435 combinations of generic_name and specific_name
- The top 15 represents 25.3% of data 
- The top 50 represents 41.3.6% of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$specific_name <- droplevels(data$specific_name)

# Removing generics
specific_name<- data %>%
  drop_na(specific_name)
  
# Combine genus + species
specific_name <- specific_name %>% 
  mutate(specific_name = paste(generic_name, "-",specific_name))

specific_name <-specific_name %>% 
  group_by(specific_name) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(specific_name) %>%
  arrange(desc(percentage)) 

DT::datatable(specific_name, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 22: ', 
                htmltools::em('Specific common names for the wildlife product'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
specific_name %>% mutate(percentage=percentage*100) %>%
  top_n(20, percentage) %>%
  plot_ly(x=~reorder(specific_name, desc(percentage)), y=~percentage, 
        color=~specific_name) %>% 
  add_bars() %>%
  layout(title = "<b>Specific common names for the wildlife product (Top 20)</b>",
         xaxis= list(title= "<b>Specific Name</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

# Combine generic_name and specific_name in the dataset
data <- data %>% mutate(specific_name = paste(generic_name, "-",specific_name))

rm(specific_name)
``` 

## More data cleaning after exploratory analysis 
**Let's exclude from the analysis those descriptions with less than 10 instances**. We reduce the number of descriptions from 88 to 78
```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# data<-data %>% 
#   group_by(description) %>%
#   filter(n()>=10)     # 5,451,832 <- 5,451,800 rows
# 
# # Dropping unused levels
# data$description <- droplevels(data$description)
```

**Let's exclude from the analysis those species with less than 10 instances**. We reduce the number of species from 8,088 to 6,426
```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# data<-data %>% 
#   group_by(species) %>%
#   filter(n()>=10)     # 5,451,800 <- 5,421,893 rows
# 
# # Dropping unused levels
# data$species <- droplevels(data$species)
```
