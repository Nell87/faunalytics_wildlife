# Exploratory analysis

Here you can check data fields and fields descriptions for all variables appearing in the dataset

**Variables related with the trade process:**

* **control_number**: It represents a unique individual shipment processed by the USFWS.
* **quantity**: It represents the numeric quantity of the wildlife produc 
* **unit**: It represents the unit for the numeric quantity
* **import_export**: It represents whether the shipment is an (I)mport or (E)xport
* **action**: Action taken by USFWS on import ((C)leared/(R)efused)
* **shipment_date**: Full date when shipment arrived
* **shipment_year**: Year when the shipment arrived (derived from "shiptment_year")
* **disposition**: Fate of the import
* **disposition_date**: Full date when disposition occurred
* **disposition_year**: Year when disposition occurred (derived from "disposition_date")

**Variables related with the countries:**

* **country_origin**: It represents the code for the country of origin of the wildlife product
* **country_imp_exp**: It represents the code for the country to/from which the wildlife product is shipped
* **port**: It represents the port or region of shipment entry
* **us_co**: It represents the US party of the shipment
* **foreign_co**: It represents the foreign party of the shipment

**Variables related with the product:**

* **description**: It represents the type/form of the wildlife product
* **value**: It represents the reported value of the wildlife product in US dollars
* **purpose**: It represents the reason the wildlife product is being imported
* **source**: It represents the type of source within the origin country (e.g., wild, bred)
* **species_code**: It represents the USFWS code for the wildlife product
* **taxa**: It represents the USFWS-derived broad taxonomic categorization
* **class**: It represents the EHA-derived class-level taxonomic designation
* **genus**: It represents the Genus (or higher-level taxonomic name) of the wildlife product
* **species**: It represents species of the wildlife product
* **subspecies**: It represents subspecies of the wildlife product
* **specific_name**: It represents a specific common name for the wildlife product
* **generic_name**: It represents a general common name for the wildlife product

## Variables related with the trade process:

### control_number 
**It represents a unique individual shipment processed by the USFWS.** 

- There are 2,088,676 unique shiptments 
- Different wildlife products contained within the same shipment may be represented in the LEMIS data by multiple data rows, all of which share a common ‘control_number’. 
- All rows of data sharing the same ‘control_number’ share the same country of shipment and shipment date. 

### quantity and unit
**Quantity** represents the numeric quantity of the wildlife product, while **unit** represents the unit of measure for the numeric quantity.

- There are 13 types of units. 
- 94.64% of data is represented with the unit "numbers"

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Renaming levels
data <- data %>% 
  mutate(unit = recode(unit, "NO" = "Number", "KG" = "Kilograms", 
                       "GM"= "Grams", "M2"="Square_meters", 
                       "LT"= "Liters", "ML"= "Milliliters", 
                       "MT"="Meters", "CM" = "Centimeters", 
                       "C3"= "Cubic_centimeters", "C2"="Square_centimeters",
                       "MG"="Miligrams", "M3"="Cubic_meters"))

units <-data %>% group_by(unit) %>%
  summarise(total = n(),percentage=n()/nrow(data)) %>%
  drop_na(unit) %>%
  arrange(desc(percentage)) 

DT::datatable(units, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 1: ', 
                htmltools::em('Units of measure'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
units %>% mutate(percentage=percentage*100) %>%
plot_ly(x=~reorder(unit, desc(percentage)), y=~percentage, color=~unit) %>% 
  add_bars() %>%
  layout(title = "<b>Units of measure</b>",
         xaxis= list(title= "<b>Units</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(units)
```
### import_export
**It represents Whether the shipment is an (I)mport or (E)xport**. In this dataset, 100% of the data is an import. 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Renaming levels
data <- data %>% 
  mutate(import_export = recode(import_export, "I" = "Import"))

imports <-data %>% group_by(import_export) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  arrange(desc(percentage)) 

DT::datatable(imports, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 2: ', 
                htmltools::em('Shipments: Imports and exports'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
imports %>% mutate(percentage=percentage*100) %>%
plot_ly(x=~reorder(import_export, desc(percentage)), y=~percentage, color=~import_export) %>% 
  add_bars() %>%
  layout(title = "<b>Shipments: Imports and exports</b>",
         xaxis= list(title= "<b>Imports and exports</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))
                       
rm(imports)
```

### action
**Action taken by the USFWS on import ((C)leared/(R)efused)**

- 98.28% of imports are cleared, just 1.73% is refused  

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Renaming levels
data <- data %>% 
  mutate(action = recode(action, "C" = "Cleared", "R"= "Refused"))

action <-data %>% group_by(action) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(action) %>%
  arrange(desc(percentage)) 

DT::datatable(action, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 3: ', 
                htmltools::em('Action taken by the USFWS on imports'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
action %>% mutate(percentage=percentage*100) %>%
plot_ly(x=~reorder(action, desc(percentage)), y=~percentage, color=~action) %>% 
  add_bars() %>%
  layout(title = "<b>Action taken by the USFWS on imports</b>",
         xaxis= list(title= "<b>Actions</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))
                       
rm(action)

```

### disposition
**It represents the fate of the import**

- There are 5 categories: C, S, A, R and non-standard value  
- The C category represents 98.3% of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
disposition <-data %>% group_by(disposition) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(disposition) %>%
  arrange(desc(percentage)) 

DT::datatable(disposition, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 4: ', 
                htmltools::em('Fate of the import'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
disposition %>% mutate(percentage=percentage*100) %>%
plot_ly(x=~reorder(disposition, desc(percentage)), y=~percentage, color=~disposition) %>% 
  add_bars() %>%
  layout(title = "<b>Fate of the import</b>",
         xaxis= list(title= "<b>Dispositions</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(disposition)
                       
```
### shipment_date and disposition_date
**Shipment_date** represents the date when shipment arrived, while **disposition_date** represents the date when disposition occurred. 

**54% of dispositions took place within a month of the shipment date (most of them within a week)**

- While ‘shipment_date’ entries fell completely within the time period of 2000–2014, ‘disposition_date’ ranged more widely 
- Users should be wary of any disposition date values that precede the associated shipment date, as we are unaware of how this could represent an accurate accounting of the product disposition process. However, for many potential analyses, differences in the date fields may not be a significant cause for concern because ‘shipment_date’ alone provides a sound index for those interested in temporal trends in wildlife trade

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
days<- data %>% 
  mutate(days = as.factor(as.numeric(disposition_date - shipment_date))) %>%
  group_by(days) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>% 
  filter(days %in% c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10",
                     "11", "12", "13", "14", "15", "16", "17", "18", "19", "20",
                     "21", "22", "23", "24", "25", "26", "27", "28", "29", "30")) 

DT::datatable(days, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 5: ', 
                htmltools::em('Number of dispositions within a month of the shipment date'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
days %>% mutate(percentage=percentage*100) %>%
plot_ly(x=~reorder(days, percentage), y=~percentage) %>% 
  add_bars() %>%
  layout(title = "<b>Percentage of dispositions within a month of the shipment date</b>",
         xaxis= list(title= "<b>Days</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(days)
```

## Variables related with the countries
### country_origin
**It represents the code for the country of origin of the wildlife product**

- There are 252 countries of origin 
- The top 15 represents 74.5% of data 
- The top 50 represents 94.4% of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Renaming levels)
data$country_origin<- countrycode(data$country_origin, "iso2c", 
                                  "country.name", nomatch = NULL)
data <- data %>% 
  mutate(country_origin = recode(country_origin, "AN" = "Netherlands Antilles",
                                "XX" = "Unknown","ZZ" = "High Seas"))

country_origin <-data %>% group_by(country_origin) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(country_origin) %>%
  arrange(desc(percentage)) 

DT::datatable(country_origin, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 6: ', 
                htmltools::em('Country of origin of the wildlife product'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
country_origin %>% mutate(percentage=percentage*100) %>%
  top_n(30, percentage) %>%
  plot_ly(x=~reorder(country_origin, desc(percentage)), y=~percentage, 
        color=~country_origin) %>% 
  add_bars() %>%
  layout(title = "<b>Country of origin of the wildlife product (Top 30)</b>",
         xaxis= list(title= "<b>Country of origin</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))


```

### country_imp_exp
**It represents the code for the country to/from which the wildlife product is shipped**

- There are 257 countries to/from which the product is shipped 
- The top 15 represents 75.9% of data 
- The top 50 represents 95.9% of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Renaming levels)
data$country_imp_exp<- countrycode(data$country_imp_exp, "iso2c", 
                                  "country.name", nomatch = NULL)
data <- data %>% 
  mutate(country_imp_exp = recode(country_imp_exp, "AN" = "Netherlands Antilles",
                                "XX" = "Unknown","ZZ" = "High Seas"))

country_imp_exp <-data %>% group_by(country_imp_exp) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(country_imp_exp) %>%
  arrange(desc(percentage)) 

DT::datatable(country_imp_exp, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 7: ', 
                htmltools::em('Country to/from which the wildlife product is shipped'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
country_imp_exp %>% mutate(percentage=percentage*100) %>%
  top_n(30, percentage) %>%
  plot_ly(x=~reorder(country_imp_exp, desc(percentage)), y=~percentage, 
        color=~country_imp_exp) %>% 
  add_bars() %>%
  layout(title = "<b>Country to/from which the wildlife product is shipped (Top 30)</b>",
         xaxis= list(title= "<b>country_imp_exp</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

```

**Most problematic countries are on both sides (country of origin & country to/from which the wildlife product is shipped)**
```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}

country_origin <- country_origin %>%
  mutate(percentage=percentage*100) %>% top_n(4, percentage) %>%
  rename(country = country_origin)

country_imp_exp <- country_imp_exp %>%
  mutate(percentage=percentage*100) %>% top_n(4, percentage) %>%
  rename(country = country_imp_exp)

countries<- combine(country_origin, country_imp_exp) 

countries %>%
  plot_ly(x=~reorder(country, desc(percentage)), y=~percentage, 
        color=~source) %>% 
  add_bars() %>%
  layout(title = "<b>Most problematic countries</b>",
         xaxis= list(title= "<b>Country</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(country_origin)
rm(country_imp_exp)
rm(countries)
```

### port
**It represents the port or region of shipment entry**

- There are 73 ports 
- The top 15 represents 83.9% of data

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Renaming levels
data <- data %>% 
  mutate(port = recode(port, "LA" = "Los Angeles, CA","NY" = "New York, NY",
                             "MI" = "Miami, FL", "NW" = "Newark, NJ",
                              "SF" = "San Francisco, CA", "CH" = "Chicago, IL", 
                              "DF" = "Dallas/Fort Worth, TX", 
                              "LO" = "Louisville, KY ", "AN" = "Anchorage, AK", 
                              "HN"= "Houston, TX", "ME" = "Memphis, TN", 
                              "AT" = "Atlanta, GA","HA" = "Honolulu, HI",
                              "SE" = "Seattle, WA", "PB" = "Pembina, ND"))

port <-data %>% group_by(port) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(port) %>%
  arrange(desc(percentage)) 

DT::datatable(port, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 8: ', 
                htmltools::em('Port or region of shipment entry'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
port %>% mutate(percentage=percentage*100) %>%
  top_n(15, percentage) %>%
  plot_ly(x=~reorder(port, desc(percentage)), y=~percentage, 
        color=~port) %>% 
  add_bars() %>%
  layout(title = "<b>Port or region of shipment entry (Top 15)</b>",
         xaxis= list(title= "<b>Port</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(port)
```

### us_co
**It represents the US party of the shipment**

- We have excluded the "EXEMPTIONS 6 AND 7(C)" from the analysis. 
- There are 126,052 US parties 
- The top 15 just represents 10.3% of data 
- The top 50 just represents 19 % of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
us_co <-data %>% 
  filter(!us_co == "EXEMPTIONS 6 AND 7(C)") %>%
  group_by(us_co) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(us_co) %>%
  arrange(desc(percentage)) 

DT::datatable(us_co, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 9: ', 
                htmltools::em('US party of the shipment'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
us_co %>% mutate(percentage=percentage*100) %>%
  top_n(20, percentage) %>%
  plot_ly(x=~reorder(us_co, desc(percentage)), y=~percentage, 
        color=~us_co) %>% 
  add_bars() %>%
  layout(title = "<b>US party of the shipment (Top 20)</b>",
         xaxis= list(title= "<b>US party</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(us_co)
```

We want to analyze which American corporations are importing the most. So, we have grouped the mayor corporations based on the company names. 

We’ve grouped most of those companies that represent at least 19% of the data, covering approximately 1.000.000 observations.

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE, out.width='90%'}
data$corporation<- # Fashion/Luxury/Design products 
                   ifelse(grepl("prada", data$us_co, ignore.case = TRUE), "Prada", 
                   ifelse(grepl("ralph lauren", data$us_co, ignore.case = TRUE), 
                          "Ralph Lauren", 
                   ifelse(grepl("LOUIS VUITTON", data$us_co, ignore.case = TRUE), 
                          "Louis Vuitton",
                   ifelse(grepl("MONCLER", data$us_co, ignore.case = TRUE), 
                          "Moncler",
                   ifelse(grepl("BOTTEGA VENETA", data$us_co, ignore.case = TRUE), 
                          "Bottega Veneta",                         
                   ifelse(grepl("RICHEMONT", data$us_co, ignore.case = TRUE), 
                          "Richemont",   
                   ifelse(grepl("FENDI", data$us_co, ignore.case = TRUE), 
                          "Fendi", 
                   ifelse(grepl("HERMES", data$us_co, ignore.case = TRUE), 
                          "Hermès",
                   ifelse(grepl("GUCCI", data$us_co, ignore.case = TRUE), 
                          "Gucci",
                   ifelse(grepl("Beeline", data$us_co, ignore.case = TRUE), 
                          "Beeline Group",    
                   ifelse(grepl("fossil partner", data$us_co, ignore.case = TRUE), 
                          "Fossil Partners, L.P.",         
                   ifelse(grepl("dfs", data$us_co, ignore.case = TRUE), 
                          "DFS Group",      
                   ifelse(grepl("gluck", data$us_co, ignore.case = TRUE), 
                          "E. Gluck Corporation",     
                   ifelse(grepl("ferragamo", data$us_co, ignore.case = TRUE), 
                          "Salvatore Ferragamo",                               
                   ifelse(grepl("jacadi", data$us_co, ignore.case = TRUE), 
                          "Jacadi",    
                   ifelse(grepl("bomac", data$us_co, ignore.case = TRUE), 
                          "Bomac International Corp",                           
                   ifelse(data$us_co %in% c("PIER I IMPORTS, INC.", 
                                            "PIER 1 IMPORTS, INC.	"), 
                          "Pier 1",  
                          
                   # Museums
                   ifelse(grepl("museum", data$us_co, ignore.case = TRUE), 
                          "Museums", 
                   ifelse(grepl("smithsonian", data$us_co, ignore.case = TRUE), 
                          "Museums",                           
                          
                   # Animals or animal products providers   
                   ifelse(grepl("SEA DWELLING", data$us_co, ignore.case = TRUE), 
                          "Sea Dwelling creatures",   
                   ifelse(grepl("HIPPOCAMPE", data$us_co, ignore.case = TRUE), 
                          "Hippocampe USA", 
                   ifelse(grepl("AQUA-NAUTIC", data$us_co, ignore.case = TRUE), 
                          "Aqua Nautic Specialist", 
                   ifelse(grepl("UNDERWATER WORLD", data$us_co, ignore.case = TRUE), 
                          "Underwater World",
                   ifelse(grepl("GOLDEN INA", data$us_co, ignore.case = TRUE), 
                          "Golden Ina",
                   ifelse(grepl("QUALITY MARINE", data$us_co, ignore.case = TRUE), 
                          "Quality Marine",
                   ifelse(grepl("Arsian", data$us_co, ignore.case = TRUE), 
                          "Arsian Imports",      
                   ifelse(grepl("aquarium arts", data$us_co, ignore.case = TRUE), 
                          "Aquarium Arts", 
                   ifelse(grepl("WALT SMITH", data$us_co, ignore.case = TRUE), 
                          "Walt Smith International", 
                   ifelse(grepl("all seas fisheries", data$us_co, ignore.case = TRUE), 
                          "Allseas Fisheries",        
                   ifelse(grepl("sun pet ltd", data$us_co, ignore.case = TRUE), 
                          "Sun Pet LTD",         
                   ifelse(grepl("pacific aqua farms", data$us_co, ignore.case = TRUE), 
                          "Pacific Aquafarms",  
                   ifelse(grepl("INTINENTAL", data$us_co, ignore.case = TRUE), 
                          "Intinental Pri",                    
                   ifelse(grepl("AQUACO", data$us_co, ignore.case = TRUE), 
                          "Aquaco",                       
                   ifelse(grepl("all seas marine", data$us_co, ignore.case = TRUE), 
                          "Allseas Marine",                    
                   ifelse(grepl("transship discounts", data$us_co, ignore.case = TRUE), 
                          "Transship Discounts LTD",     
                   ifelse(grepl("SEGREST FARMS", data$us_co, ignore.case = TRUE), 
                          "Segrest Farms",  
                   ifelse(grepl("fish head", data$us_co, ignore.case = TRUE), 
                          "Fish Heads Inc",     
                   ifelse(grepl("holiday coral", data$us_co, ignore.case = TRUE), 
                          "Holiday Coral Inc",                           
                   ifelse(grepl("pacific island imp", data$us_co, ignore.case = TRUE), 
                          "Pacific Island Imports",     
                   ifelse(grepl("PAN OCEAN AQUARIUM", data$us_co, ignore.case = TRUE), 
                          "Pan Ocean Aquarium, Inc",   
                   ifelse(grepl("SALTWATER INC.", data$us_co, ignore.case = TRUE), 
                          "Saltwater Inc",      
                   ifelse(grepl("saltwaterfish", data$us_co, ignore.case = TRUE), 
                          "Saltwaterfish",         
                   ifelse(grepl("golden sea int", data$us_co, ignore.case = TRUE), 
                          "Golden Sea Inc",                           
                   ifelse(grepl("strictly reptiles", data$us_co, ignore.case = TRUE), 
                          "Strictly Reptiles Inc",                            
                   ifelse(grepl("emark tropical", data$us_co, ignore.case = TRUE), 
                          "Emark Tropical Imports, Inc",                              
                          	
                   ifelse(data$us_co %in% c("DOLPHIN INTERNATIONAL", "DOLPHIN INT'L",
                                            "DOLPHIN INTERNAITONAL"), 
                          "Dolphin International", 
                   ifelse(data$us_co %in% c("a & m aquatics", "A&M AQUATICS"), 
                          "A&M Aquatics",           
                   ifelse(data$us_co %in% c("LPS LLC", "LPS, LLC", "LPS"), 
                          "LPS LLC",    
                   ifelse(data$us_co %in% c("APET, INC", "APET INC"), 
                          "Apet Inc",   

                          "Other")))))))))))))))))))))))))))))))))))))))))))))))))

data_corporations <- data %>%
  mutate(corporation = as.factor(corporation)) 

# Let's classify these corporations
corp_fashion<- c("Beeline Group", "Bomac International Corp", "Bottega Veneta", 
                 "DFS Group","E. Gluck Corporation", "Fendi", 
                 "Fossil Partners, L.P.", "Gucci", "Hermès", "Jacadi", 
                 "Louis Vuitton","Moncler", "Pier 1","Prada", "Ralph Lauren",
                 "Richemont", "Salvatore Ferragamo")

corp_animalproviders<-c("A&M Aquatics", "Aqua Nautic Specialist", "Aquaco",
                        "Aquarium Arts", "Allseas Fisheries", "Allseas Marine",
                        "Apet Inc", "Arsian Imports", "Dolphin International",
                        "Emark Tropical Imports, Inc", "Fish Heads Inc",
                        "Golden Ina", "Golden Sea Inc", "Hippocampe USA",
                        "Holiday Coral Inc", "Intinental Pri", "LPS LLC",
                        "Pacific Aquafarms", "Pacific Island Imports",
                        "Pan Ocean Aquarium, Inc", "Quality Marine",
                        "Saltwater Inc", "Saltwaterfish", "Sea Dwelling creatures",
                        "Segrest Farms", "Strictly Reptiles Inc", "Sun Pet LTD",
                        "Transship Discounts LTD", "Underwater World",
                        "Walt Smith International")

data$corp_classif<- ifelse(data$corporation %in% corp_fashion, "Fashion/Luxury/Design",
                    ifelse(data$corporation %in% corp_animalproviders, 
                           "Animal/animal prod. providers", 
                    ifelse(data$corporation %in% "Museums", "Museums", "Others"))) 

data$corporation<-as.factor(data$corporation)
data$corp_classif<- as.factor(data$corp_classif)

# Let's summarize and graph these corporations
data_corporations<- data %>% 
  group_by(corp_classif, corporation) %>%
  dplyr::summarise(total=n(), percentage=n()/nrow(data)) %>%
  arrange(desc(total)) %>%
  filter(corporation!="Other") 

DT::datatable(data_corporations, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 10: ', 
                htmltools::em('Which American corporations are importing the most'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
data_corporations %>% mutate(percentage=percentage*100) %>%
  top_n(15, percentage) %>%
  plot_ly(x=~reorder(corporation, desc(percentage)), y=~percentage, 
        color=~corp_classif) %>% 
  add_bars() %>%
  layout(title = "<b>Which American corporations are importing the most (Top 15)</b>",
         xaxis= list(title= "<b>American corporation</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

## Graph by classification
data_corporations %>% mutate(percentage=percentage*100) %>%
  filter(corp_classif == "Fashion/Luxury/Design") %>%
  plot_ly(x=~reorder(corporation, desc(percentage)), y=~percentage, 
         marker = list(color = "coral")) %>% 
  add_bars() %>%
  layout(title = "<b>Fashion/Luxury/Design Corporations</b>",
         xaxis= list(title= "<b>American corporation</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

data_corporations %>% mutate(percentage=percentage*100) %>%
  filter(corp_classif == "Animal/animal prod. providers") %>%
  plot_ly(x=~reorder(corporation, desc(percentage)), y=~percentage, 
         marker = list(color = "green")) %>% 
  add_bars() %>%
  layout(title = "<b>Animal/animal prod. providers Corporations</b>",
         xaxis= list(title= "<b>American corporation</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(corp_animalproviders, corp_fashion, data_corporations)

```

### foreign_co
**It represents the foreign party of the shipment**

- There are 237,994 foreign parties 
- The top 15 just represents  5.4% of data 
- The top 50 just represents 12.4% of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
foreign_co <-data %>% 
  filter(!foreign_co == "EXEMPTIONS 6 AND 7(C)") %>%
  group_by(foreign_co) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(foreign_co) %>%
  arrange(desc(percentage)) 

DT::datatable(foreign_co, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 11: ', 
                htmltools::em('Foreign party of the shipment'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
foreign_co %>% mutate(percentage=percentage*100) %>%
  top_n(20, percentage) %>%
  plot_ly(x=~reorder(foreign_co, desc(percentage)), y=~percentage, 
        color=~foreign_co) %>% 
  add_bars() %>%
  layout(title = "<b>Foreign party of the shipment (Top 20)</b>",
         xaxis= list(title= "<b>Foreign party of the shipment</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(foreign_co)
```

## Variables related with the product
### description
**It represents the type/form of the wildlife product**

- There are 88 types/forms 
- Most of them are "Live specimens" (29.1%), followed by trophies (16.83%) and "Shell products" (9.49%). 
- The top 15 represents 94.19% of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$description <- droplevels(data$description)

# Renaming levels)
data <- data %>% 
  mutate(description = recode(description, 
                              "LIV" = "Live specimen", "TRO" = "Trophy", 
                              "SPR" = "Shell product", "LPS" = "Leather product",
                              "JWL" = "Jewelry", "GAR" = "Garment", 
                              "SHO" = "Shoe", "TRI" = "Trim", "MEA" = "Meat",
                              "SPE" = "Specimen", "SKI" = "Skin", 
                              "BOD" = "Dead animal","LPL" = "Leather product",
                              "SHE" = "Shell", "FEA"= "Feather", 
                              "HOR" = "Horn", "IVC" ="Ivory carving", 
                              "IVP" = "Ivory piece", "UNS" = "Unspecified"))
                       
description <-data %>% 
  group_by(description) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(description) %>%
  arrange(desc(percentage)) 

DT::datatable(description, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 12: ', 
                htmltools::em('Type/form of the wildlife product'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
description %>% mutate(percentage=percentage*100) %>%
  top_n(20, percentage) %>%
  plot_ly(x=~reorder(description, desc(percentage)), y=~percentage, 
        color=~description) %>% 
  add_bars() %>%
  layout(title = "<b>Type/form of the wildlife product (Top 20)</b>",
         xaxis= list(title= "<b>Description</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(description)
```

### value
**It represents the reported value of every shipment in US dollars**. 
- Lower values are more common than higher values
- The min value is 0 dollars while the max value is 118,000,000 dollars   
- The halway point, the median, is 187$ 
- 50% of shipments are between 30 dollars (1st quartile) and 1260 dollars (3rd quartile)


```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
summary(data$value)

# Data between the minimum value and the 3rd quartile
data %>% 
  filter(value>=0 & value<=1260) %>%
  plot_ly(x=~value, type='histogram', nbinsx = 40) %>%
  layout(title = "<b>Number of shipments with a value between 0 and 1260 US dollars.</b>",
         xaxis= list(title= "<b>Value</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Count</b>"))

```

### purpose
**It represents the reason the wildlife product is being imported**
- There are 13 purpose levels 
- Commercial (74.6%) and "hunting trophies" (17.81%) purposes represent 92.41 % of the data.  

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Renaming levels)
data <- data %>% 
  mutate(purpose = recode(purpose, 
                   "B" = "Breeding in captivity or artificial propagation", 
                   "E" = "Educational", "G" = "Botanical Gardens",
                   "H" = "Hunting trophies", "M" = "Biomedical research",
                   "P" = "Personal", "Q" = "Circuses/traveling exhibitions",
                   "S" = "Scientific", "T" = "Commercial", 
                   "Y" = "Reintroduction/introduction into the wild",
                   "Z" = "Zoos"))
                              
purpose <-data %>% 
  group_by(purpose) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(purpose) %>%
  arrange(desc(percentage)) 

DT::datatable(purpose, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 13: ', 
                htmltools::em('Reasons the wildlife products are being imported'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
purpose %>% mutate(percentage=percentage*100) %>%
  plot_ly(x=~reorder(purpose, desc(percentage)), y=~percentage, 
        color=~purpose) %>% 
  add_bars() %>%
  layout(title = "<b>Reasons the wildlife products are being imported</b>",
         xaxis= list(title= "<b>Purposes</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(purpose)
```

### source
**It represents the type of source within the origin country (e.g., wild, bred)**
- There are 10 source levels 
- Specimens taken from the wild (77.9%) and animals bred in captivity (14.8%) sources represent 92.7 % of the data.  

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Renaming levels)
data <- data %>% 
  mutate(source = recode(source, 
                         "W" = "Specimens taken from the wild", 
                         "C" = "Animals bred in captivity", 
                         "R" = "Specimens originating from a ranching operation",
                         "F" = "Animals born in captivity or not captive-bred",
                         "U" = "Source unknown", 
                         "D" = "commercially bred or propagated in CITES",
                         "I" = "Confiscated or seized specimens", 
                         "A" = "Plants artificially propagated, parts and derivates"))
                              
source <-data %>% 
  group_by(source) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(source) %>%
  arrange(desc(percentage)) 

DT::datatable(source, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 14: ', 
                htmltools::em('Types of source within the origin country'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
source %>% mutate(percentage=percentage*100) %>%
  plot_ly(x=~reorder(source, desc(percentage)), y=~percentage, 
        color=~source) %>% 
  add_bars() %>%
  layout(title = "<b>Types of source within the origin country</b>",
         xaxis= list(title= "<b>Sources</b>" ,tickangle=-65, tickfont = list(size = 10)),
         yaxis = list(title = "<b>Percentage</b>"))

rm(source)
```

### species_code
**It represents the USFWS code for the wildlife product**

- There are 15, 322 unique species codes 
- The top 15 represents 30 % of data 
- The top 50 represents 50.4% of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$species_code <- droplevels(data$species_code)

species_code <-data %>% 
  group_by(species_code) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(species_code) %>%
  arrange(desc(percentage)) 

DT::datatable(species_code, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 15: ', 
                htmltools::em('USFWS code for the wildlife product'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
species_code %>% mutate(percentage=percentage*100) %>%
  top_n(20, percentage) %>%
  plot_ly(x=~reorder(species_code, desc(percentage)), y=~percentage, 
        color=~species_code) %>% 
  add_bars() %>%
  layout(title = "<b>USFWS code for the wildlife product (Top 20)</b>",
         xaxis= list(title= "<b>USFWS code</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(species_code)
```

### taxa
**It represents the USFWS-derived broad taxonomic categorization**

- There are 13 taxa levels
- There is a ‘taxa’ field for the vast majority (>99%) of records
- Most of them are mammals (29.16%), followed by shells (20.34%), reptiles (13.29%) and corals (12.63%). These four categories represent 75,42% of data

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$taxa <- droplevels(data$taxa)

taxa <-data %>% 
  group_by(taxa) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(taxa) %>%
  arrange(desc(percentage)) 

DT::datatable(taxa, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 16: ', 
                htmltools::em('USFWS-derived broad taxonomic categorization'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
taxa %>% mutate(percentage=percentage*100) %>%
  plot_ly(x=~reorder(taxa, desc(percentage)), y=~percentage, 
        color=~taxa) %>% 
  add_bars() %>%
  layout(title = "<b>USFWS-derived broad taxonomic categorization</b>",
         xaxis= list(title= "<b>Taxa</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(taxa)
```

### class
**It represents the EHA-derived class-level taxonomic designation**
- There are 53 classes
- The top 15 represents 93% of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$class <- droplevels(data$class)

class <-data %>% 
  group_by(class) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(class) %>%
  arrange(desc(percentage)) 

DT::datatable(class, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 17: ', 
                htmltools::em(' EHA-derived class-level taxonomic designation'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
class %>% mutate(percentage=percentage*100) %>%
  top_n(20, percentage) %>%
  plot_ly(x=~reorder(class, desc(percentage)), y=~percentage, 
        color=~class) %>% 
  add_bars() %>%
  layout(title = "<b>EHA-derived class-level taxonomic designation (Top 20)</b>",
         xaxis= list(title= "<b>Class</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(class)
```

### genus
**It represents the Genus (or higher-level taxonomic name) of the wildlife product**

- There are 6,335 genus levels 
- The top 15 represents 33.4 of data
- The top 50 represents 57.3% of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$genus <- droplevels(data$genus)

genus <-data %>% 
  group_by(genus) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(genus) %>%
  arrange(desc(percentage)) 

DT::datatable(genus, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 18: ', 
                htmltools::em('Genus (or higher-level taxonomic name) of the wildlife product'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
genus %>% mutate(percentage=percentage*100) %>%
  top_n(20, percentage) %>%
  plot_ly(x=~reorder(genus, desc(percentage)), y=~percentage, 
        color=~genus) %>% 
  add_bars() %>%
  layout(title = "<b>Genus (or higher-level taxonomic name) of the wildlife product (Top 20)</b>",
         xaxis= list(title= "<b>Genus</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(genus)
```

### species
**It represents species of the wildlife product**. To get a more ilustrative name, we'll combine genus and species. 

- After removing generics, there are 8,082 different species
- The top 15 represents 23.8 % of data
- The top 50 represents 38.3 % of data

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$species <- droplevels(data$species)

# Removing generics
species<- data %>%
  filter(!species %in% c("maxima", "sp.", "in trop fish &", "(marine sp.)",
                        "(freshwater sp.)", "(including goldfish)")) %>%
  drop_na(species)
  
# Combine genus + species
species <- species %>% mutate(species = as.factor(paste(genus, "-",species)))

species <-species %>% 
  group_by(species) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(species) %>%
  arrange(desc(percentage)) 

DT::datatable(species, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 19: ', 
                htmltools::em('Species of the wildlife product'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
species %>% mutate(percentage=percentage*100) %>%
  top_n(20, percentage) %>%
  plot_ly(x=~reorder(species, desc(percentage)), y=~percentage, 
        color=~species) %>% 
  add_bars() %>%
  layout(title = "<b>Species of the wildlife product (Top 20)</b>",
         xaxis= list(title= "<b>Species</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

# Combine genus + species in the dataset
data <- data %>% mutate(species = as.factor(paste(genus, "-",species)))

rm(species)
```

### subspecies
**It represents subspecies of the wildlife product**

- There are 439 subspecies levels 
- The top 15 just represents 2.5% of data 
- The top 50 just represents 2.6% of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$subspecies <- droplevels(data$subspecies)

subspecies <-data %>% 
  group_by(subspecies) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  filter(subspecies!="other shipments") %>%
  drop_na(subspecies) %>%
  arrange(desc(percentage))

DT::datatable(subspecies, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 20: ', 
                htmltools::em('Subespecies of the wildlife product'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
subspecies %>% mutate(percentage=percentage*100) %>%
  top_n(20, percentage) %>%
  plot_ly(x=~reorder(subspecies, desc(percentage)), y=~percentage, 
        color=~subspecies) %>% 
  add_bars() %>%
  layout(title = "<b>Subespecies of the wildlife product (Top 20)</b>",
         xaxis= list(title= "<b>Subespecies</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(subspecies)

```
### generic_name
**It represents a general common name for the wildlife product**

- There are 1,987 generic names levels 
- The top 15 represents 49.3% of data 
- The top 50 represents 71.6% of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$generic_name <- droplevels(data$generic_name)

generic_name <-data %>% 
  group_by(generic_name) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(generic_name) %>%
  arrange(desc(percentage))

DT::datatable(generic_name, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 21: ', 
                htmltools::em('General common names for the wildlife product'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
generic_name %>% mutate(percentage=percentage*100) %>%
  top_n(20, percentage) %>%
  plot_ly(x=~reorder(generic_name, desc(percentage)), y=~percentage, 
        color=~generic_name) %>% 
  add_bars() %>%
  layout(title = "<b>General common names for the wildlife product (Top 20)</b>",
         xaxis= list(title= "<b>Generic Name</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

rm(generic_name)
```

### specific_name
**It represents a specific common name for the wildlife product**. For getting a more ilustrative name, we'll combine generic_name and specific_name 

- After removing empty values, there are 10,435 combinations of generic_name and specific_name
- The top 15 represents 25.3% of data 
- The top 50 represents 41.3.6% of data 

```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
# Dropping unused levels
data$specific_name <- droplevels(data$specific_name)

# Removing generics
specific_name<- data %>%
  drop_na(specific_name)
  
# Combine genus + species
specific_name <- specific_name %>% 
  mutate(specific_name = paste(generic_name, "-",specific_name))

specific_name <-specific_name %>% 
  group_by(specific_name) %>%
  summarise(total = n(), percentage=n()/nrow(data)) %>%
  drop_na(specific_name) %>%
  arrange(desc(percentage)) 

DT::datatable(specific_name, 
              caption = htmltools::tags$caption(
                style='caption-side: bottom; text-align: center;','Table 22: ', 
                htmltools::em('Specific common names for the wildlife product'
              ))) %>%
  formatRound('total',1) %>%
  formatPercentage('percentage',2)
  
specific_name %>% mutate(percentage=percentage*100) %>%
  top_n(20, percentage) %>%
  plot_ly(x=~reorder(specific_name, desc(percentage)), y=~percentage, 
        color=~specific_name) %>% 
  add_bars() %>%
  layout(title = "<b>Specific common names for the wildlife product (Top 20)</b>",
         xaxis= list(title= "<b>Specific Name</b>" ,tickangle=-65),
         yaxis = list(title = "<b>Percentage</b>"))

# Combine generic_name and specific_name in the dataset
data <- data %>% mutate(specific_name = paste(generic_name, "-",specific_name))

rm(specific_name)
``` 

## More data cleaning after exploratory analysis 
**Let's exclude from the analysis those descriptions with less than 10 instances**. We reduce the number of descriptions from 88 to 78
```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
data<-data %>% 
  group_by(description) %>%
  filter(n()>=10)     # 5,451,832 <- 5,451,800 rows

# Dropping unused levels
data$description <- droplevels(data$description)
```

**Let's exclude from the analysis those species with less than 10 instances**. We reduce the number of species from 8,088 to 6,426
```{r eval=TRUE, echo=TRUE, warning=FALSE, include=TRUE}
data<-data %>% 
  group_by(species) %>%
  filter(n()>=10)     # 5,451,800 <- 5,421,893 rows

# Dropping unused levels
data$species <- droplevels(data$species)
```
